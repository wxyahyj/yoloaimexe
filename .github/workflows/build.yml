name: Build YOLO Detector

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup CMake
      uses: lukka/get-cmake@latest
      
    - name: Cache Qt
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/qt
        key: qt-6.5.0-windows
        restore-keys: |
          qt-6.5.0-
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        dir: '${{ github.workspace }}/qt'
        install-deps: 'true'
        
    - name: Cache OpenCV
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/opencv
        key: opencv-4.13.0-windows
        restore-keys: |
          opencv-
      
    - name: Download Pre-built OpenCV
      run: |
        if (-not (Test-Path "opencv")) {
          $ProgressPreference = 'SilentlyContinue'
          # Download pre-built OpenCV using the provided URL
          Invoke-WebRequest -Uri "https://github.com/opencv/opencv/releases/download/4.13.0/opencv-4.13.0-windows.exe" -OutFile "opencv.exe"
          # Extract using 7zip (available in GitHub Actions)
          7z x "opencv.exe" -o"opencv" -y
        }
      working-directory: ${{ github.workspace }}
        
    - name: Cache ONNX Runtime
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/onnxruntime
        key: onnxruntime-1.15.1-windows
        restore-keys: |
          onnxruntime-
      
    - name: Download ONNX Runtime
      run: |
        if (-not (Test-Path "onnxruntime")) {
          $ProgressPreference = 'SilentlyContinue'
          Invoke-WebRequest -Uri "https://github.com/microsoft/onnxruntime/releases/download/v1.15.1/onnxruntime-win-x64-gpu-1.15.1.zip" -OutFile "onnxruntime.zip"
          Expand-Archive -Path "onnxruntime.zip" -DestinationPath "." -Force
          Rename-Item -Path "onnxruntime-win-x64-gpu-1.15.1" -NewName "onnxruntime"
        }
      working-directory: ${{ github.workspace }}
      
    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_PREFIX_PATH="${{ github.workspace }}/qt/6.5.0/msvc2019_64;${{ github.workspace }}/opencv/build" -DCMAKE_BUILD_PARALLEL_LEVEL=8
      working-directory: ${{ github.workspace }}
      
    - name: Build
      run: cmake --build build --config Release --parallel 8
      working-directory: ${{ github.workspace }}
      
    - name: Deploy Qt
      run: |
        $qtBin = "${{ github.workspace }}/qt/6.5.0/msvc2019_64/bin"
        $buildDir = "${{ github.workspace }}/build/bin/Release"
        & $qtBin/windeployqt.exe $buildDir/yolo_detector_exe.exe
      working-directory: ${{ github.workspace }}
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: yolo-detector-windows
        path: |
          ${{ github.workspace }}/build/bin/Release/
          
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: /var/cache/apt
        key: apt-dependencies-linux
        restore-keys: |
          apt-
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libopencv-dev qt6-base-dev qt6-base-dev-tools
      
    - name: Cache ONNX Runtime
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/onnxruntime
        key: onnxruntime-1.15.1-linux
        restore-keys: |
          onnxruntime-
      
    - name: Download ONNX Runtime
      run: |
        if [ ! -d "onnxruntime" ]; then
          wget https://github.com/microsoft/onnxruntime/releases/download/v1.15.1/onnxruntime-linux-x64-1.15.1.tgz
          tar -xzf onnxruntime-linux-x64-1.15.1.tgz
          mv onnxruntime-linux-x64-1.15.1 onnxruntime
        fi
      working-directory: ${{ github.workspace }}
      
    - name: Configure CMake
      run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_BUILD_PARALLEL_LEVEL=8
      working-directory: ${{ github.workspace }}
      
    - name: Build
      run: cmake --build build --config Release --parallel 8
      working-directory: ${{ github.workspace }}
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: yolo-detector-linux
        path: |
          ${{ github.workspace }}/build/
